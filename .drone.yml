kind: pipeline
type: docker
name: deploy-bot

steps:
  - name: build-and-deploy
    image: docker/compose:latest
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    environment:
      BOT_TOKEN:
        from_secret: BOT_TOKEN
      # ç™¾åº¦OCRç›¸å…³çš„çŽ¯å¢ƒå˜é‡
      BAIDU_APPID:
        from_secret: BAIDU_APPID
      BAIDU_SECRET:
        from_secret: BAIDU_SECRET
      BAIDU_OCR_TOKEN:
        from_secret: BAIDU_OCR_TOKEN
      # AIæœåŠ¡é…ç½®
      DEEPSEEK_API_KEY:
        from_secret: DEEPSEEK_API_KEY
      # ç¬”è®°æœåŠ¡é…ç½®
      FLOMO_WEBHOOK:
        from_secret: FLOMO_WEBHOOK
      NOTION_API_KEY:
        from_secret: NOTION_API_KEY
      NOTION_PAGE_ID:
        from_secret: NOTION_PAGE_ID
      # Redisé…ç½® - å¤–éƒ¨æœåŠ¡å™¨
      REDIS_URL: redis://192.168.0.105:6379
      # è¿è¡ŒçŽ¯å¢ƒé…ç½®
      NODE_ENV: production
      TZ: Asia/Shanghai

    commands:
      # å®‰è£…å¿…è¦å·¥å…·
      - apk add --no-cache bash curl

      # æ£€æŸ¥å¤–éƒ¨Redisè¿žæŽ¥
      - echo "ðŸ” æ£€æŸ¥å¤–éƒ¨RedisæœåŠ¡å™¨è¿žæŽ¥..."
      - ping -c 3 192.168.0.105 || (echo "âŒ æ— æ³•pingé€šRedisæœåŠ¡å™¨" && exit 1)

      # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
      - echo "ðŸ”§ é…ç½®çŽ¯å¢ƒå˜é‡..."
      - |
        cat > .env << EOF
        BOT_TOKEN=$${BOT_TOKEN}
        DEEPSEEK_API_KEY=$${DEEPSEEK_API_KEY}
        REDIS_URL=$${REDIS_URL}
        NODE_ENV=$${NODE_ENV}
        TZ=$${TZ}
        BAIDU_APPID=$${BAIDU_APPID}
        BAIDU_SECRET=$${BAIDU_SECRET}
        BAIDU_OCR_TOKEN=$${BAIDU_OCR_TOKEN}
        FLOMO_WEBHOOK=$${FLOMO_WEBHOOK}
        NOTION_API_KEY=$${NOTION_API_KEY}
        NOTION_PAGE_ID=$${NOTION_PAGE_ID}
        EOF

      # åœæ­¢æ—§æœåŠ¡
      - echo "ðŸ›‘ åœæ­¢æ—§æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml down || true
      - docker-compose -f docker-compose.yml down || true

      # æ¸…ç†æ—§å®¹å™¨å’Œé•œåƒ
      - echo "ðŸ§¹ æ¸…ç†æ—§èµ„æº..."
      - docker container prune -f || true
      - docker image prune -f || true

      # æž„å»ºå’Œéƒ¨ç½²æ–°æœåŠ¡
      - echo "ðŸš€ æž„å»ºå’Œéƒ¨ç½²æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml build
      - docker-compose -f docker-compose.prod.yml up -d

      # ç­‰å¾…æœåŠ¡å°±ç»ª
      - echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
      - sleep 30

      # å¥åº·æ£€æŸ¥
      - echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
      - docker-compose -f docker-compose.prod.yml ps
      - docker-compose -f docker-compose.prod.yml exec -T bot node -e "console.log('âœ… Botå®¹å™¨æ­£å¸¸')" || (echo "âŒ Botå®¹å™¨å¼‚å¸¸" && exit 1)
      - docker-compose -f docker-compose.prod.yml exec -T bot sh -c "redis-cli -h 192.168.0.105 -p 6379 ping" || (echo "âŒ Redisè¿žæŽ¥å¤±è´¥" && exit 1)

      # æ˜¾ç¤ºéƒ¨ç½²ç»“æžœ
      - echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      - echo "ðŸ“Š æœåŠ¡çŠ¶æ€:"
      - docker-compose -f docker-compose.prod.yml ps

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock
