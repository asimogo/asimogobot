kind: pipeline
type: docker
name: deploy-bot

steps:
  - name: build-and-deploy
    image: docker:dind
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    environment:
      COMPOSE_PROJECT_NAME: tg-bot-prod
      TZ: Asia/Phnom_Penh
      BOT_TOKEN:
        from_secret: BOT_TOKEN
      BAIDU_APPID:
        from_secret: BAIDU_APPID
      BAIDU_SECRET:
        from_secret: BAIDU_SECRET
      BAIDU_OCR_TOKEN:
        from_secret: BAIDU_OCR_TOKEN
      DEEPSEEK_API_KEY:
        from_secret: DEEPSEEK_API_KEY
      FLOMO_WEBHOOK:
        from_secret: FLOMO_WEBHOOK
      NOTION_API_KEY:
        from_secret: NOTION_API_KEY
      NOTION_PAGE_ID:
        from_secret: NOTION_PAGE_ID
      REDIS_URL: redis://192.168.0.105:6379
      NODE_ENV: production
    commands:
      # å®‰è£… Docker Compose
      - apk add --no-cache bash curl python3 py3-pip
      - pip3 install docker-compose
      - docker-compose --version

      # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
      - echo "ğŸ” æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
      - ping -c 3 192.168.0.105

      # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
      - echo "ğŸ”§ åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
      - echo "BOT_TOKEN=$${BOT_TOKEN}" > .env
      - echo "DEEPSEEK_API_KEY=$${DEEPSEEK_API_KEY}" >> .env
      - echo "REDIS_URL=$${REDIS_URL}" >> .env
      - echo "NODE_ENV=$${NODE_ENV}" >> .env
      - echo "TZ=$${TZ}" >> .env
      - echo "BAIDU_APPID=$${BAIDU_APPID}" >> .env
      - echo "BAIDU_SECRET=$${BAIDU_SECRET}" >> .env
      - echo "BAIDU_OCR_TOKEN=$${BAIDU_OCR_TOKEN}" >> .env
      - echo "FLOMO_WEBHOOK=$${FLOMO_WEBHOOK}" >> .env
      - echo "NOTION_API_KEY=$${NOTION_API_KEY}" >> .env
      - echo "NOTION_PAGE_ID=$${NOTION_PAGE_ID}" >> .env

      # éªŒè¯ç¯å¢ƒå˜é‡æ–‡ä»¶
      - echo "ğŸ“‹ éªŒè¯ç¯å¢ƒå˜é‡æ–‡ä»¶..."
      - cat .env | head -5

      # åœæ­¢æ—§æœåŠ¡
      - echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml down --remove-orphans || true

      # æ¸…ç†æ—§èµ„æº
      - echo "ğŸ§¹ æ¸…ç†æ—§èµ„æº..."
      - docker system prune -f || true

      # æ„å»ºå’Œéƒ¨ç½²æœåŠ¡
      - echo "ğŸš€ æ„å»ºå’Œéƒ¨ç½²æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml build
      - docker-compose -f docker-compose.prod.yml up -d

      # ç­‰å¾…æœåŠ¡å¯åŠ¨
      - echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
      - sleep 30

      # æ£€æŸ¥æœåŠ¡çŠ¶æ€
      - echo "ğŸ¥ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
      - docker-compose -f docker-compose.prod.yml ps

      # éªŒè¯Botå®¹å™¨
      - echo "âœ… éªŒè¯Botå®¹å™¨..."
      - docker-compose -f docker-compose.prod.yml exec -T bot node --version || echo "å®¹å™¨å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­"

      # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      - echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
      - docker-compose -f docker-compose.prod.yml logs --tail=10 bot

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock
