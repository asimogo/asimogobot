kind: pipeline
type: docker
name: telegram-bot-ci

# è§¦å‘æ¡ä»¶
trigger:
  branch:
    - main
    - develop
  event:
    - push
    - pull_request

# å…¨å±€ç¯å¢ƒå˜é‡
environment:
  DOCKER_REGISTRY: 192.168.0.105:5000 # å¦‚æœæ‚¨æœ‰æœ¬åœ° Docker Registry
  IMAGE_NAME: telegram-bot

steps:
  # 1. ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  - name: code-analysis
    image: node:20-alpine3.19
    commands:
      - npm ci
      - npm run build
      - echo "âœ… ä»£ç æ„å»ºæˆåŠŸ"
    when:
      event:
        - push
        - pull_request

  # 2. å®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼‰
  - name: security-scan
    image: aquasec/trivy:latest
    commands:
      - trivy fs --exit-code 0 --no-progress --format table .
    when:
      event:
        - push
      branch:
        - main

  # 3. æ„å»º Docker é•œåƒ
  - name: build-image
    image: plugins/docker
    settings:
      registry: 192.168.0.105:5000 # æ‚¨çš„æœ¬åœ° Docker Registry
      repo: 192.168.0.105:5000/telegram-bot
      tags:
        - latest
        - ${DRONE_COMMIT_SHA:0:8}
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      dockerfile: Dockerfile
      context: .
    when:
      event:
        - push
      branch:
        - main

  # 4. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  - name: deploy-staging
    image: appleboy/drone-ssh
    settings:
      host: 192.168.0.105 # æ‚¨çš„éƒ¨ç½²æœåŠ¡å™¨
      username:
        from_secret: ssh_username
      password:
        from_secret: ssh_password
      port: 22
      script:
        - cd /opt/telegram-bot-staging
        - docker-compose down || true
        - docker-compose pull
        - docker-compose up -d
        - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
    when:
      event:
        - push
      branch:
        - develop

  # 5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  - name: deploy-production
    image: appleboy/drone-ssh
    settings:
      host: 192.168.0.105 # æ‚¨çš„ç”Ÿäº§æœåŠ¡å™¨
      username:
        from_secret: ssh_username
      password:
        from_secret: ssh_password
      port: 22
      script:
        - cd /opt/telegram-bot
        - docker-compose -f docker-compose.prod.yml down || true
        - docker-compose -f docker-compose.prod.yml pull
        - docker-compose -f docker-compose.prod.yml up -d
        - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
    when:
      event:
        - push
      branch:
        - main

  # 6. é€šçŸ¥
  - name: notify
    image: plugins/webhook
    settings:
      urls:
        from_secret: webhook_url
      content_type: application/json
      template: |
        {
          "text": "ğŸš€ Telegram Bot éƒ¨ç½²{{#success build.status}}æˆåŠŸ{{else}}å¤±è´¥{{/success}}ï¼\nåˆ†æ”¯: {{build.branch}}\næäº¤: {{build.commit}}\næ„å»º: {{build.number}}"
        }
    when:
      status:
        - success
        - failure

---
# å®šä¹‰ secretsï¼ˆéœ€è¦åœ¨ Drone ä¸­é…ç½®ï¼‰
kind: secret
name: docker_username
data: your_docker_username_base64

---
kind: secret
name: docker_password
data: your_docker_password_base64

---
kind: secret
name: ssh_username
data: your_ssh_username_base64

---
kind: secret
name: ssh_password
data: your_ssh_password_base64

---
kind: secret
name: webhook_url
data: your_notification_webhook_url_base64
