kind: pipeline
type: docker
name: deploy-bot

steps:
  - name: build-and-deploy
    image: docker:alpine
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    environment:
      COMPOSE_PROJECT_NAME: "asimogobot"
      TZ: "Asia/Phnom_Penh"
      # â†“ ä» Drone secrets æ³¨å…¥ â†“
      BOT_TOKEN:
        from_secret: BOT_TOKEN
      BAIDU_APPID:
        from_secret: BAIDU_APPID
      BAIDU_SECRET:
        from_secret: BAIDU_SECRET
      DEEPSEEK_API_KEY:
        from_secret: DEEPSEEK_API_KEY
      FLOMO_WEBHOOK:
        from_secret: FLOMO_WEBHOOK
      NOTION_API_KEY:
        from_secret: NOTION_API_KEY
      NOTION_PAGE_ID:
        from_secret: NOTION_PAGE_ID
      REDIS_URL: "redis://192.168.0.105:6379"
      NODE_ENV: "production"
    commands:
      # å®‰è£… Docker Compose (Docker 20.x éœ€è¦æ‰‹åŠ¨å®‰è£…)
      - apk add --no-cache curl
      - |
        if [ -z "$DOCKER_CONFIG" ]; then
          DOCKER_CONFIG="$HOME/.docker"
        fi
        mkdir -p "$DOCKER_CONFIG/cli-plugins"
        curl -SL https://github.com/docker/compose/releases/download/v2.24.1/docker-compose-linux-x86_64 -o "$DOCKER_CONFIG/cli-plugins/docker-compose"
        chmod +x "$DOCKER_CONFIG/cli-plugins/docker-compose"
      - docker compose version
      # 1) å¿…å¡«é¡¹æ ¡éªŒï¼ˆé€ä¸ªå–"å€¼"ï¼Œä¸æ˜¯"åå­—"ï¼‰
      - |
        set -eu
        required_vars="BOT_TOKEN DEEPSEEK_API_KEY REDIS_URL NODE_ENV TZ BAIDU_APPID BAIDU_SECRET FLOMO_WEBHOOK NOTION_API_KEY NOTION_PAGE_ID"
        missing=0
        echo "ğŸ” Checking required envs from Drone secrets..."
        for k in $required_vars; do
          v=$(eval "echo \$${k}")
          if [ -z "$v" ]; then
            echo "âŒ $k is EMPTY or missing"
            missing=1
          else
            echo "âœ… $k is set (length: $(echo "$v" | wc -c))"
          fi
        done
        [ "$missing" -eq 0 ] || { echo "â›” Stop: some secrets are missing."; exit 1; }
        echo "âœ… All required envs are present."

      # 2) å†™å…¥ .envï¼ˆå…è®¸å˜é‡å±•å¼€ï¼‰
      - |
        echo "BOT_TOKEN=\"$BOT_TOKEN\"" > .env
        echo "BAIDU_APPID=\"$BAIDU_APPID\"" >> .env
        echo "BAIDU_SECRET=\"$BAIDU_SECRET\"" >> .env
        echo "DEEPSEEK_API_KEY=\"$DEEPSEEK_API_KEY\"" >> .env
        echo "FLOMO_WEBHOOK=\"$FLOMO_WEBHOOK\"" >> .env
        echo "NOTION_API_KEY=\"$NOTION_API_KEY\"" >> .env
        echo "NOTION_PAGE_ID=\"$NOTION_PAGE_ID\"" >> .env
        echo "REDIS_URL=\"$REDIS_URL\"" >> .env
        echo "NODE_ENV=\"$NODE_ENV\"" >> .env
        echo "TZ=\"$TZ\"" >> .env
        echo "âœ… .env generated."

      # 3) è„±æ•æ£€æŸ¥ï¼šç¡®è®¤ .env ä¸ä¸ºç©ºï¼ˆä¸æ³„éœ²å€¼ï¼‰
      - |
        echo "ğŸ” .env sanity check (masked):"
        awk -F= '{printf("%-18s %s\n",$1, ($2==""?"<EMPTY>":"<SET>"))}' .env

      # 4) æ„å»º + å¯åŠ¨ï¼ˆå¦‚æœ‰å˜åŒ–ä¼šé‡å»ºï¼‰ï¼Œå¹¶æ¸…ç†å­¤å„¿å®¹å™¨
      - docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

      # 5) åŸºæœ¬çŠ¶æ€ä¸å…³é”®ä¿¡æ¯
      - docker compose -f docker-compose.prod.yml ps
      - docker compose -f docker-compose.prod.yml logs --tail=200 --no-color bot || true

      # 6) å®¹å™¨å†…äºŒæ¬¡æ ¡éªŒï¼ˆç¡®è®¤ BOT_TOKEN å·²æ³¨å…¥ï¼›å®¹å™¨ running æ‰èƒ½ execï¼‰
      - |
        # ç­‰å¾…æœ€å¤š 30s ç›´åˆ°å®¹å™¨å˜ä¸º runningï¼ˆé¿å… "is restarting"ï¼‰
        for i in $(seq 1 30); do
          state=$(docker inspect -f '{{.State.Running}}' "$(docker compose -f docker-compose.prod.yml ps -q bot)")
          [ "$state" = "true" ] && break
          sleep 1
        done
        tok=$(docker compose -f docker-compose.prod.yml exec -T bot /bin/sh -lc 'printenv BOT_TOKEN || true' || true)
        if [ -z "$tok" ]; then
          echo "âŒ BOT_TOKEN is missing inside container."
          exit 1
        fi
        echo "âœ… BOT_TOKEN is present inside container (value hidden)."

      # 7) æ¸…ç†å·¥ä½œç›®å½•ä¸­çš„ .envï¼ˆå®¹å™¨å·²æ‹¿åˆ°ç¯å¢ƒå˜é‡ï¼‰
      - rm -f .env

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock

trigger:
  branch:
    - main
  event:
    - push
