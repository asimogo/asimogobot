kind: pipeline
type: docker
name: deploy-bot

steps:
  - name: build-and-deploy
    image: docker/compose:latest
    environment:
      #ï¼ˆå¯é€‰ï¼‰ç»™ compose éš”ç¦»å·¥ç¨‹åï¼Œé¿å…è·Ÿå…¶ä»–é¡¹ç›®å®¹å™¨å†²çª
      COMPOSE_PROJECT_NAME: tg-bot-prod
      TZ: Asia/Phnom_Penh
      # â†“â†“â†“ ä½ çš„å¯†é’¥ä»æ¥è‡ª Drone secrets â†“â†“â†“
      BOT_TOKEN:
        from_secret: BOT_TOKEN
      BAIDU_APPID:
        from_secret: BAIDU_APPID
      BAIDU_SECRET:
        from_secret: BAIDU_SECRET
      BAIDU_OCR_TOKEN:
        from_secret: BAIDU_OCR_TOKEN
      DEEPSEEK_API_KEY:
        from_secret: DEEPSEEK_API_KEY
      FLOMO_WEBHOOK:
        from_secret: FLOMO_WEBHOOK
      NOTION_API_KEY:
        from_secret: NOTION_API_KEY
      NOTION_PAGE_ID:
        from_secret: NOTION_PAGE_ID
      REDIS_URL: redis://192.168.0.105:6379
      NODE_ENV: production

    volumes:
      - name: docker-sock
        path: /var/run/docker.sock

    commands:
      - set -euo pipefail

      # åŸºç¡€å·¥å…·
      - apk add --no-cache curl

      # ç”Ÿæˆ .envï¼ˆæ¨èï¼šä»“åº“æ”¾ä¸€ä¸ª .env.templateï¼‰
      # å¦‚æœæš‚æ—¶æ²¡æœ‰ .env.templateï¼Œä¿ç•™ä½ çš„ heredoc ä¹Ÿè¡Œ
      - |
        if [ -f .env.template ]; then
          echo "ğŸ”§ ä½¿ç”¨ .env.template ç”Ÿæˆ .env ..."
          apk add --no-cache gettext
          envsubst < .env.template > .env
        else
          echo "ğŸ”§ ç›´æ¥ç”Ÿæˆ .env ..."
          cat > .env << EOF
          BOT_TOKEN=${BOT_TOKEN}
          DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
          REDIS_URL=${REDIS_URL}
          NODE_ENV=${NODE_ENV}
          TZ=${TZ}
          BAIDU_APPID=${BAIDU_APPID}
          BAIDU_SECRET=${BAIDU_SECRET}
          BAIDU_OCR_TOKEN=${BAIDU_OCR_TOKEN}
          FLOMO_WEBHOOK=${FLOMO_WEBHOOK}
          NOTION_API_KEY=${NOTION_API_KEY}
          NOTION_PAGE_ID=${NOTION_PAGE_ID}
          EOF
        fi

      # å¤–éƒ¨ Redis ç«¯å£è¿é€šæ€§ï¼ˆå‡†ç¡®ï¼‰
      - echo "ğŸ” æ£€æŸ¥å¤–éƒ¨ Redis è¿æ¥..."
      - docker run --rm redis:7-alpine redis-cli -h 192.168.0.105 -p 6379 PING | grep PONG

      # åœæ‰æ—§æœåŠ¡ï¼ˆç§»é™¤å­¤å„¿å®¹å™¨ï¼Œé¿å…å†å²é—ç•™ï¼‰
      - echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml down --remove-orphans || true

      # æ„å»ºå¹¶å¯åŠ¨
      - echo "ğŸš€ æ„å»ºå¹¶éƒ¨ç½²æœåŠ¡..."
      - docker-compose -f docker-compose.prod.yml up -d --build

      # ç­‰å¾…å¥åº·ï¼ˆè‹¥é…ç½®äº† healthcheckï¼Œè¿™é‡Œä¼šæ›´ç²¾å‡†ï¼‰
      - echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
      - sleep 8
      - docker-compose -f docker-compose.prod.yml ps

      # è½»é‡è¿è¡Œæ£€æŸ¥ï¼šç¡®ä¿èƒ½ exec è¿›å…¥ bot å¹¶æ‰§è¡Œ node
      - echo "ğŸ¥ è¿è¡Œæ£€æŸ¥ï¼ˆbot å®¹å™¨ï¼‰..."
      - docker-compose -f docker-compose.prod.yml exec -T bot node -e "console.log('âœ… Botå®¹å™¨å¯ç”¨')"

      # Redis å†æ¬¡éªŒè¯
      - docker run --rm redis:7-alpine redis-cli -h 192.168.0.105 -p 6379 PING | grep PONG

      # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
      - echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      - echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
      - docker-compose -f docker-compose.prod.yml ps
